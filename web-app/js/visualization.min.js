function changeStudy(){$("#select_rows, #select_columns, #select_groups").empty();$("#select_rows, #select_columns, #select_groups").next().val("");if(visualization)visualization.destroy();if($("#select_study").find("option:selected").length>0){$("#select_rows, #select_columns, #select_groups").parents(".menu_header").find("img.spinner").show();executeAjaxCall("getFields","menu_study",{errorMessage:"An error occurred while retrieving variables from the server. Please try again or contact a system administrator.",success:function(e,t,n){if(e.infoMessage){showError(e.infoMessage,"message_warning")}if(e.returnData&&e.returnData.studyIds==$("#select_study option:selected").val()){var r=e.returnData.fields;var i="";var s="<option value=''>Select One...</option>";$.each(r,function(e,t){if(t.category!=i){if(i.length>0)s+="</optgroup>";s+="<optgroup label='"+t.source+": "+t.category+"' onClick='return false;'>";i=t.category}s+="<option value='"+t.id+"'>"+t.name+"</option>"});if(s.length>0){s+="</optgroup>";$("#select_rows, #select_columns, #select_groups").html(s)}else{$("#visualization").html('<div style="padding: 30px">No fields could be found. This visualization prototype requires studies with samples.</div>')}$("#select_study").parents(".menu_header").find(".menu_header_count").switchClass("menu_fill","menu_done",1e3);$("#select_rows, #select_columns, #select_groups").parents(".menu_header").find("img.spinner").hide();$("#select_rows, #select_columns, #select_groups").parents(".menu_header").find(".menu_header_count").addClass("menu_fill")}}})}}function changeFields(e){$("#"+e).parents(".menu_header").find(".menu_header_count").switchClass("menu_fill","menu_done",1e3);if($("#select_rows").find("option:selected").val().length>0&&$("#select_columns").find("option:selected").val().length>0){$("#select_types, #select_aggregation").parents(".menu_header").find("img.spinner").show();executeAjaxCall("getVisualizationTypes",e,{errorMessage:"An error occurred while retrieving visualization types from the server. Please try again or contact a system administrator.",success:function(e,t,n){if(e.infoMessage!=null){showError(e.infoMessage,"message_warning")}if(e.returnData&&e.returnData.rowIds==$("#select_rows option:selected").val()&&e.returnData.columnIds==$("#select_columns option:selected").val()){var r=e.returnData.types;var i=e.returnData.aggregations;if(currAggr==null){currAggr="average"}else{currAggr=$("#select_aggregation input:checked").val()}currType=$("#select_types input:checked").val();$("#select_types, #select_aggregation").parents(".menu_header").find(".menu_header_count").addClass("menu_fill");$("#select_aggregation input, #select_types input").each(function(e){$(this).attr("disabled","disabled")});$.each(r,function(e,t){$("#vis_"+t.id).attr("disabled",false);if(t.id==currType||r.length==1){currType=t.id;$("#vis_"+t.id).attr("checked","checked");$("#select_types").parents(".menu_header").find(".menu_header_count").switchClass("menu_fill","menu_done",1e3)}});$.each(i,function(e,t){if(!t.disabled)$("#aggr_"+t.id).attr("disabled",false);if(t.id==currAggr||i.length==1){currAggr=t.id;$("#aggr_"+t.id).attr("checked","checked");$("#select_aggregation").parents(".menu_header").find(".menu_header_count").switchClass("menu_fill","menu_done",1e3)}});changeVis()}$("#select_types, #select_aggregation").parents(".menu_header").find("img.spinner").hide()}})}}function changeRadio(e){if($(e).attr("name")=="aggregation"){$("#select_aggregation").parents(".menu_header").find(".menu_header_count").switchClass("menu_fill","menu_done",1e3);currAggr=$(e).val();if(currAggr!="none"){$("#vis_boxplot").attr("disabled","disabled");if(currType=="boxplot"){$("#vis_boxplot").attr("checked",false)}}else{$("#vis_boxplot").attr("disabled",false)}}else{$("#select_types").parents(".menu_header").find(".menu_header_count").switchClass("menu_fill","menu_done",1e3);currType=$(e).val();if($(e).val()=="boxplot"){$("#select_aggregation input[value=none]").attr("checked","checked");$("#select_aggregation").parents(".menu_header").find(".menu_header_count").switchClass("menu_fill","menu_done",1e3);currAggr="none"}}changeVis()}function changeVis(){if($("#autovis").attr("checked")=="checked"){visualize()}}function visualize(){if($("#select_rows").val()&&$("#select_columns").val()&&$("#select_types input:checked").length>0&&$("#select_aggregation input:checked").length>0){$("#menu_go").find(".spinner").show();executeAjaxCall("getData","menu_go",{errorMessage:"An error occurred while retrieving data from the server. Please try again or contact a system administrator.",success:function(e,t,n){if(visualization)visualization.destroy();if(e.infoMessage!=null){showError(e.infoMessage,"message_warning")}if(!checkCorrectData(e.returnData)&&e.returnData.type!="boxplot"){showError(["Unfortunately the server returned data in a format that we did not expect."],"message_error");return}var r=new Array;var s=[];var o=e.returnData;$.each(o.series,function(e,t){if(t.y&&t.y.length>0){if(o.type=="horizontal_barchart"){var n=new Array;for(var i=0;i<t.y.length;i++){n[n.length]=new Array(t.y[i],i+1)}r[r.length]=n}else if(o.type=="boxplot"){var u=t.y;u=[u[0],u[4],u[1],u[2],u[3],u[4],u[5],u[6],u[7]];r[r.length]=u}else{r[r.length]=t.y}s[s.length]={label:t.name}}});if(r.length==0){showError(["Unfortunately the server returned data without any measurements"],"message_error");$("#menu_go").find(".spinner").hide();return}var u=o["xaxis"].unit==""?o["xaxis"].title:o["xaxis"].title+" ("+o["xaxis"].unit+")";var a=o["yaxis"].unit==""?o["yaxis"].title:o["yaxis"].title+" ("+o["yaxis"].unit+")";var f="";if(o["groupaxis"]!==undefined){f=o["groupaxis"].unit==""?o["groupaxis"].title:o["groupaxis"].title+" ("+o["groupaxis"].unit+")"}var l=null;var c=$("#showvalues").attr("checked")=="checked";var h=o.series.length>1;var p=$("#legendplacement").attr("checked")=="checked"&&h?"outsideGrid":"insideGrid";var d=$("#anglelabels").attr("checked")=="checked"?-45:0;switch(o.type){case"scatterplot":$.each(o.series,function(e,t){s[e].showLine=false;s[e].markerOptions={size:7,style:"filledCircle"}});case"linechart":l={stackSeries:false,seriesDefaults:{renderer:$.jqplot.LineRenderer,pointLabels:{show:c}},series:s,highlighter:{show:!c,sizeAdjust:7.5,tooltipAxes:"y"},legend:{show:h,placement:p},axes:{xaxis:{renderer:$.jqplot.CategoryAxisRenderer,ticks:o.series[0].x,labelRenderer:$.jqplot.CanvasAxisLabelRenderer,label:u,tickRenderer:$.jqplot.CanvasAxisTickRenderer,tickOptions:{angle:d}},yaxis:{label:a,labelRenderer:$.jqplot.CanvasAxisLabelRenderer,formatString:"%.2f"}},axesDefaults:{pad:1.4}};break;case"horizontal_barchart":l={stackSeries:false,seriesDefaults:{renderer:$.jqplot.BarRenderer,rendererOptions:{barMargin:30,highlightMouseDown:true,barDirection:"horizontal",highlightMouseDown:true,fillToZero:true},pointLabels:{show:c}},highlighter:{show:!c,sizeAdjust:7.5,tooltipAxes:"x"},legend:{show:h,placement:p},series:s,axes:{xaxis:{labelRenderer:$.jqplot.CanvasAxisLabelRenderer,label:u,formatString:"%.2f",min:0,tickRenderer:$.jqplot.CanvasAxisTickRenderer,tickOptions:{angle:d}},yaxis:{labelRenderer:$.jqplot.CanvasAxisLabelRenderer,label:a,tickRenderer:$.jqplot.CanvasAxisTickRenderer,ticks:o.series[0].x,renderer:$.jqplot.CategoryAxisRenderer}},axesDefaults:{pad:1.4}};break;case"barchart":l={stackSeries:false,seriesDefaults:{renderer:$.jqplot.BarRenderer,rendererOptions:{barMargin:30,highlightMouseDown:true,fillToZero:true},pointLabels:{show:c}},highlighter:{show:!c,sizeAdjust:7.5,tooltipAxes:"y"},legend:{show:h,placement:p},series:s,axes:{xaxis:{renderer:$.jqplot.CategoryAxisRenderer,ticks:o.series[0].x,label:u,labelRenderer:$.jqplot.CanvasAxisLabelRenderer,tickRenderer:$.jqplot.CanvasAxisTickRenderer,tickOptions:{angle:d}},yaxis:{label:a,labelRenderer:$.jqplot.CanvasAxisLabelRenderer,formatString:"%.2f"}},axesDefaults:{pad:1.4}};break;case"table":var v=$("<table>").addClass("tablevis");var m=$("<tr>");if(s.length==1){m.append("<td class='caption' colspan='2' rowspan='2'>&nbsp;</td>")}else{m.append("<td class='caption' colspan='2'>&nbsp;</td>")}m.append("<td class='caption' colspan='"+o.series[0].x.length+"'>"+u+"</td>");m.appendTo(v);var m=$("<tr>");if(s.length>1){m.append("<td class='caption'>"+f+"</td>");m.append("<td class='caption'>"+a+"</td>")}for(j=0;j<o.series[0].x.length;j++){m.append("<th>"+o.series[0].x[j]+"</th>")}m.appendTo(v);for(k=0;k<o.series.length;k++){for(i=0;i<o.series[0].y.length;i++){var m=$("<tr>");for(j=-1;j<o.series[0].x.length;j++){if(j<0){if(i==0){if(s.length==1){m.append("<td class='caption' rowspan='"+o.series[0].y.length+"'>"+a+"</td>")}else{m.append("<td class='caption' rowspan='"+o.series[0].y.length+"'>"+o.series[k].name+"</td>")}}m.append("<th>"+o.series[k].y[i]+"</th>")}else{m.append("<td>"+o.series[k].data[j][i]+"</td>")}}m.appendTo(v)}}l=v;break;case"boxplot":r=[r];l={series:[{renderer:$.jqplot.BoxplotRenderer,rendererOptions:{}}],highlighter:{show:true,sizeAdjust:7.5,showMarker:true,tooltipAxes:"y",yvalues:8,formatString:'<table class="jqplot-highlighter dummy%s">'+"<tr><td>Maximum:</td><td>%s</td></tr>"+"<tr><td>Median + 1.5*IQR:</td><td>%s</td></tr>"+"<tr><td>Q3:</td><td>%s</td></tr>"+"<tr><td>Median:</td><td>%s</td></tr>"+"<tr><td>Q1:</td><td>%s</td></tr>"+"<tr><td>Median - 1.5*IQR:</td><td>%s</td></tr>"+"<tr><td>Minimum:</td><td>%s</td></tr>"+"</table>"},axesDefaults:{pad:1.4},axes:{xaxis:{renderer:$.jqplot.CategoryAxisRenderer,label:u,labelRenderer:$.jqplot.CanvasAxisLabelRenderer,tickRenderer:$.jqplot.CanvasAxisTickRenderer,tickOptions:{angle:d}},yaxis:{min:0}}};break}if(l!=null){$("#visualization").css("width",$("#visualization_container").innerWidth()-2);$("#visualization").css("height",$("#visualization_container").innerHeight()-2);$("#visualization").empty();if(o.type=="table"){$("#visualization").html(l)}else{visualization=$.jqplot("visualization",r,l)}$("#visualization").show()}$("#menu_go").find(".spinner").hide()}})}}function showError(e,t){for(index in e){var n=$("<div>").css("position","absolute").css("top","3px").css("right","10px").html("<a href='#' onclick='removeError(this); return false;'>x</a>");$("#message_container").prepend($("<div>").addClass("message_box "+t).html(e[index]).css("position","relative").fadeIn().append(n))}var r="&nbsp;"+$(".message_box").length+" message";if($(".message_box").length!=1){r=r+"s"}$("#messages_link").html(r)}function removeError(e){$(e).closest(".message_box").remove();var t="&nbsp;"+$(".message_box").length+" message";if($(".message_box").length!=1){t=t+"s"}$("#messages_link").html(t);if($(".message_box").length==0){$("#dialog_messages").dialog("close")}}function clearSelect(e,t){var n=$(e).parents(".menu_header").find(".block_variable");$(n).children("input, select").val("");$(n).children("input").data("ui-autocomplete").term="";if(t==1){$(e).parents(".menu_item").children(".menu_header").each(function(e){if($(this).find("select").val()!=null&&$(this).find("select").val()!=""){clearSelect($(this).find("select"),0);$(this).find("select").empty();$(this).find("input").val("");$(this).children(".menu_header_count").removeClass().addClass("menu_header_count")}})}if(t>=1){$(e).parents(".menu_header").children(".menu_header_count").removeClass().addClass("menu_header_count menu_fill");visualize()}}function checkCorrectData(e){return"type"in e&&"xaxis"in e&&"yaxis"in e&&"series"in e&&$.isArray(e.series)}function gatherData(e){return $("#visualizationForm").serialize()}function executeAjaxCall(e,t,n){var r=gatherData(e);if(!n)n={};if(n["errorMessage"]){var i=n["errorMessage"];n["error"]=function(e,n,r){showError(["An error occurred while retrieving variables from the server. Please try again or contact a system administrator.<br />"+n],"message_error");$("#"+t).parents(".menu_header").find(".menu_header_count").switchClass("menu_fill","menu_error",1e3);$("#"+t).parents(".menu_header").find("img.spinner").hide()};delete n["errorMessage"]}$.ajax($.extend({url:visualizationUrls[e],type:"POST",data:r,dataType:"json"},n))}var visualization=null;var currType=null;var currAggr=null;jQuery.expr[":"].Contains=function(e,t,n){return jQuery(e).text().toUpperCase().indexOf(n[3].toUpperCase())>=0};$(document).ready(function(){$("#dialog_messages, #dialog_advanced_settings").dialog({autoOpen:false,modal:true,resizable:false,show:"slide",hide:"slide",zIndex:10002,buttons:{Ok:function(){$(this).dialog("close")}}});$("#select_study").combobox();$("#select_rows").combobox();$("#select_columns").combobox();$("#select_groups").combobox();$(".ui-autocomplete-input").click(function(){$(this).blur();$(this).autocomplete("search","");$(this).focus()});$.jqplot.config.enablePlugins=true;var e=[2,-6,7,-5];var t=["a","b","c","d"];var n=[name="count",x=["a","b","c","d"],y=[2,-6,7,-5]]});(function(e){e.widget("ui.combobox",e.ui.autocomplete,{_create:function(){var t=this,n=this.element.hide(),r=n.children(":selected"),i=r.val()?r.text():"";var s=this.input=e("<input>").insertAfter(n).val(i).autocomplete({delay:0,minLength:0,source:function(t,r){var i=new RegExp(e.ui.autocomplete.escapeRegex(t.term),"i");var s="";r(n.find("option, optgroup").map(function(){if(this.nodeName=="OPTION"){var n=e(this).text();if(this.value&&(!t.term||i.test(n)||i.test(s))){return{category:s,label:n.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+e.ui.autocomplete.escapeRegex(t.term)+")(?![^<>]*>)(?![^&;]+;)","gi"),"$1"),value:n,option:this}}}else{s=e(this).attr("label")}}))},select:function(e,r){console.log(e);console.log(r);r.item.option.selected=true;t._trigger("selected",e,{item:r.item.option});n.trigger("change")},change:function(t,r){if(!r.item){var i=new RegExp("^"+e.ui.autocomplete.escapeRegex(e(this).val())+"$","i"),o=false;n.children("option").each(function(){if(e(this).text().match(i)){this.selected=o=true;return false}});if(!o){e(this).val("");n.val("");s.data("ui-autocomplete").term="";return false}}}})},destroy:function(){this.input.remove();this.element.show();e.Widget.prototype.destroy.call(this)}})})(jQuery)