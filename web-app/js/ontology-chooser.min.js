/**
 *  Ontology Chooser, use any NCBO ontology with a text input element
 *  Copyright (C) 2010 Jeroen Wesbeek
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function OntologyChooser(){}OntologyChooser.prototype={cache:[],ctrl:false,noSearch:false,clipboard:[],options:{minLength:1,showHide:null,spinner:"http://www.ajaxload.info/images/exemples/2.gif"},init:function(a){var b=this;if(a){$.each(a,function(c,d){b.options[c]=d})}if(this.options.showHide){this.options.showHide.hide()}$(".ontologySearcher").each(function(){b.initOntologyAutocomplete(this)});$("input[rel*='ontology']").each(function(){b.initAutocomplete(this)})},initAutocomplete:function(d){var f=this;var g=$(d);var e=false;var h=$("input[name='apikey']").val();var c=g.attr("rel").split("-");var b=c[1];var a=c[2];if(b=="all"){b=""}g.bind("keydown",function(i){if(i.keyCode==17||i.keyCode==224){f.ctrl=true}if(i.keyCode==13){return false}if(i.keyCode==8&&f.options.showHide){f.options.showHide.hide()}if(i.keyCode==67&&f.ctrl){return f.copy(g)}if(i.keyCode==86&&f.ctrl){return f.paste(g)}});g.bind("keyup",function(i){if(i.keyCode==17||i.keyCode==224){f.ctrl=false}});g.autocomplete({minLength:f.options.minLength,delay:300,search:function(i,j){if(f.noSearch){f.noSearch=false;return false}if(f.options.spinner){g.css({background:"url("+f.options.spinner+") no-repeat right center"})}e=false},source:function(k,i){var l=$.trim(k.term);var j="http://data.bioontology.org/search?q="+l+"&ontologies="+b+"&apikey="+h;if(f.cache[l]){g.css({background:"none"});i(f.cache[l])}else{$.getJSON(j,function(n){var m=f.parseTerms(n.collection);f.cache[l]=m;g.css({background:"none"});if(!n.collection){if(f.options.showHide){f.options.showHide.hide()}f.setInputValue(g,"ontology_id",null);f.setInputValue(g,"concept_id",null)}i(m)})}},select:function(j,k){e=true;var i=g;f.setInputValue(i,"ontology_id",k.item.ontologyUrl);f.setInputValue(g,"concept_id",k.item.concept_id);i.removeClass("error");if(f.options.showHide){f.options.showHide.show()}},close:function(j,k){if(!e){var i=g;g.val("");f.setInputValue(i,"ontology_id","");f.setInputValue(g,"concept_id","");i.addClass("error")}},html:true}).data("ui-autocomplete")._renderItem=function(i,j){return $("<li></li>").data("item.autocomplete",j).append('<a><span class="about">'+j.value+'</span><span class="from">'+j.ontologyUrl+"</span></a>").appendTo(i)}},initOntologyAutocomplete:function(a){var c=this;var d=$(a);var b=false;var e=$("input[name='apikey']").val();d.bind("keydown",function(f){if(f.keyCode==17||f.keyCode==224){c.ctrl=true}if(f.keyCode==13){return false}if(f.keyCode==8&&c.options.showHide){c.options.showHide.hide()}if(f.keyCode==67&&c.ctrl){return c.copy(d)}if(f.keyCode==86&&c.ctrl){return c.paste(d)}});d.bind("keyup",function(f){if(f.keyCode==17||f.keyCode==224){c.ctrl=false}});d.autocomplete({minLength:0,delay:300,search:function(f,g){if(c.noSearch){c.noSearch=false;return false}if(c.options.spinner){d.css({background:"url("+c.options.spinner+") no-repeat right center"})}b=false},source:function(h,f){var i=$.trim(h.term);var g="http://data.bioontology.org/ontologies?apikey="+e;if(c.cache[i]){d.css({background:"none"});f(c.cache[i])}else{$.getJSON(g,function(k){k=k.filter(function(l){return l.acronym.toLowerCase().indexOf(i.toLowerCase())!=-1});var j=c.parseOntologies(k);c.cache[i]=j;d.css({background:"none"});if(!k.collection){if(c.options.showHide){c.options.showHide.hide()}c.setInputValue(d,"ontology_id",null)}f(j)})}},select:function(g,h){b=true;var f=d;c.setInputValue(f,"ontology_id",h.item.ontologyUrl);f.removeClass("error");if(c.options.showHide){c.options.showHide.show()}},close:function(g,h){if(!b){var f=d;d.val("");c.setInputValue(f,"ontology_id","");f.addClass("error")}},html:true})},setInputValue:function(e,c,d){var a=e.attr("name")+"-"+c;var b=e.parent().find("input[name='"+a+"']");if(b.size()>0){$(b[0]).val(d)}else{e.after('<input type="hidden" name="'+a+'" value="'+d+'"/>')}},getInputValue:function(d,c){var a=d.attr("name")+"-"+c;var b=d.parent().find("input[name='"+a+"']");return(b.size()>0)?$(b[0]).val():""},parseTerms:function(b){var a=[];$.each(b,function(c,d){a[c]={value:d.prefLabel,preferred_name:d.prefLabel,ontologyUrl:d.links.ontology,concept_id:d["@id"]}});return a},parseOntologies:function(b){var a=[];$.each(b,function(c,d){a[c]={value:d.acronym,label:'<span class="about">('+d.acronym+')</span> <span class="from">full name: '+d.name+"</span>",preferred_name:d.acronym,ontologyUrl:d["@id"]}});return a},copy:function(a){this.clipboard={sourceValue:$(a).val(),ontology_id:this.getInputValue(a,"ontology_id"),concept_id:this.getInputValue(a,"concept_id")};return false},paste:function(b){if(this.clipboard.sourceValue&&this.clipboard.concept_id&&this.clipboard.ncbo_id&&this.clipboard.full_id){var a=new RegExp(this.clipboard.ncbo_id);if(b.attr("rel").match(a)||b.attr("rel").match(/all/)){this.noSearch=true;$(b).val(this.clipboard.sourceValue);this.setInputValue(b,"ontology_id",this.clipboard.ontology_id);this.setInputValue(b,"concept_id",this.clipboard.concept_id)}}return false}};